# äººç”ŸKçº¿ - AI å¤§æ¨¡å‹é›†æˆæŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

### æŠ€æœ¯é€‰å‹

| é¡¹ç›® | é€‰æ‹© |
|------|------|
| åç«¯æ¶æ„ | Node.js + Express ä»£ç†æœåŠ¡ |
| AI æ¨¡å‹ | Google Gemini API |
| éƒ¨ç½²æ–¹å¼ | ç‹¬ç«‹æœåŠ¡å™¨ / VPS |

### æ ¸å¿ƒç›®æ ‡

- âœ… ç”¨æˆ·æ— éœ€ VPNï¼Œé€šè¿‡é¡¹ç›®æ–¹æœåŠ¡å™¨ä»£ç†è®¿é—® Gemini API
- âœ… å®ç°ä¸‰ä¸ªç”ŸæˆåŠŸèƒ½ï¼šKçº¿ä¸»åˆ†æã€è´¢å¯Œæ·±åº¦åˆ†æã€æ¡ƒèŠ±æ·±åº¦åˆ†æ
- âœ… ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åç›´æ¥ç”Ÿæˆï¼Œæ— éœ€æ‰‹åŠ¨å¤åˆ¶ç²˜è´´

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·æµè§ˆå™¨                                       â”‚
â”‚                          (æ— éœ€ VPN / ä»»æ„ç½‘ç»œ)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ HTTPS è¯·æ±‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     é¡¹ç›®æ–¹åç«¯ä»£ç†æœåŠ¡å™¨                                       â”‚
â”‚                  (éƒ¨ç½²åœ¨å¯è®¿é—® Google API çš„æœåŠ¡å™¨)                            â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚ /api/generate â”‚   â”‚ /api/wealth   â”‚   â”‚ /api/love     â”‚                â”‚
â”‚   â”‚   Kçº¿ä¸»åˆ†æ    â”‚   â”‚  è´¢å¯Œæ·±åº¦åˆ†æ  â”‚   â”‚  æ¡ƒèŠ±æ·±åº¦åˆ†æ  â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚           â”‚                   â”‚                   â”‚                        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                               â–¼                                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                    â”‚   Gemini API è°ƒç”¨    â”‚                                 â”‚
â”‚                    â”‚   (æœåŠ¡ç«¯ä»£ç†è¯·æ±‚)    â”‚                                 â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ æœåŠ¡å™¨æœ‰å¤–ç½‘è®¿é—®èƒ½åŠ›
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Google Gemini API                                    â”‚
â”‚                   https://generativelanguage.googleapis.com                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç‚¹

1. **ç”¨æˆ·ç«¯**ï¼šåªéœ€èƒ½è®¿é—®é¡¹ç›®æ–¹æœåŠ¡å™¨å³å¯ï¼Œæ— éœ€ VPN
2. **æœåŠ¡å™¨ç«¯**ï¼šéƒ¨ç½²åœ¨å¯ä»¥è®¿é—® Google API çš„æœåŠ¡å™¨ï¼ˆæµ·å¤– VPS æˆ–é…ç½®ä»£ç†ï¼‰
3. **API Key**ï¼šå­˜å‚¨åœ¨æœåŠ¡å™¨ç¯å¢ƒå˜é‡ä¸­ï¼Œå¯¹ç”¨æˆ·å®Œå…¨é€æ˜

---

## ğŸ“ ç›®å½•ç»“æ„

### åç«¯æœåŠ¡ï¼ˆæ–°å»ºï¼‰

```
lifekline-server/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ .env                      # ç¯å¢ƒå˜é‡ï¼ˆä¸æäº¤åˆ° Gitï¼‰
â”œâ”€â”€ .env.example              # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ generate.ts       # Kçº¿ä¸»åˆ†æè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ wealth.ts         # è´¢å¯Œæ·±åº¦åˆ†æè·¯ç”±
â”‚   â”‚   â””â”€â”€ love.ts           # æ¡ƒèŠ±æ·±åº¦åˆ†æè·¯ç”±
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ gemini.ts         # Gemini API å°è£…
â”‚   â”œâ”€â”€ prompts/
â”‚   â”‚   â”œâ”€â”€ main.ts           # Kçº¿ä¸»åˆ†æ Prompt
â”‚   â”‚   â”œâ”€â”€ wealth.ts         # è´¢å¯Œåˆ†æ Prompt
â”‚   â”‚   â””â”€â”€ love.ts           # æ¡ƒèŠ±åˆ†æ Prompt
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ parseJson.ts      # JSON è§£æå·¥å…·
â””â”€â”€ README.md
```

### å‰ç«¯å˜æ›´

```
lifekline-main/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ apiService.ts         # æ–°å¢ï¼šè°ƒç”¨åç«¯ API
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ImportDataMode.tsx    # ä¿®æ”¹ï¼šå¢åŠ ä¸€é”®ç”ŸæˆæŒ‰é’®
â”‚   â”œâ”€â”€ DeepAnalysisPanel.tsx # ä¿®æ”¹ï¼šå¢åŠ ä¸€é”®ç”ŸæˆæŒ‰é’®
â”‚   â””â”€â”€ GeneratingModal.tsx   # æ–°å¢ï¼šç”Ÿæˆä¸­å¼¹çª—
â””â”€â”€ ...
```

---

## ğŸ”§ åç«¯å®ç°

### 1. ç¯å¢ƒé…ç½®

#### `.env.example`

```env
# æœåŠ¡å™¨ç«¯å£
PORT=3001

# Gemini API é…ç½®
GEMINI_API_KEY=your_gemini_api_key_here
GEMINI_MODEL=gemini-1.5-flash

# å¯é€‰ï¼šå¦‚æœæœåŠ¡å™¨éœ€è¦ä»£ç†è®¿é—® Google
# HTTP_PROXY=http://127.0.0.1:7890
# HTTPS_PROXY=http://127.0.0.1:7890

# å…è®¸çš„å‰ç«¯åŸŸåï¼ˆCORSï¼‰
ALLOWED_ORIGINS=http://localhost:5173,https://your-domain.com
```

#### `package.json`

```json
{
  "name": "lifekline-server",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js"
  },
  "dependencies": {
    "@google/generative-ai": "^0.21.0",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.21.0"
  },
  "devDependencies": {
    "@types/cors": "^2.8.17",
    "@types/express": "^4.17.21",
    "@types/node": "^22.0.0",
    "tsx": "^4.19.0",
    "typescript": "^5.6.0"
  }
}
```

### 2. å…¥å£æ–‡ä»¶

#### `src/index.ts`

```typescript
import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import generateRouter from './routes/generate.js';
import wealthRouter from './routes/wealth.js';
import loveRouter from './routes/love.js';

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3001;

// CORS é…ç½®
const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:5173'];
app.use(cors({
  origin: (origin, callback) => {
    // å…è®¸æ—  origin çš„è¯·æ±‚ï¼ˆå¦‚ Postmanï¼‰
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
}));

app.use(express.json({ limit: '1mb' }));

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// API è·¯ç”±
app.use('/api/generate', generateRouter);
app.use('/api/wealth', wealthRouter);
app.use('/api/love', loveRouter);

// é”™è¯¯å¤„ç†
app.use((err: any, req: express.Request, res: express.Response, next: express.NextFunction) => {
  console.error('Error:', err);
  res.status(500).json({ error: err.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' });
});

app.listen(PORT, () => {
  console.log(`ğŸš€ Server running on http://localhost:${PORT}`);
  console.log(`ğŸ“¡ Gemini Model: ${process.env.GEMINI_MODEL || 'gemini-1.5-flash'}`);
});
```

### 3. Gemini API å°è£…

#### `src/services/gemini.ts`

```typescript
import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');

export interface GenerateOptions {
  systemPrompt: string;
  userPrompt: string;
  maxTokens?: number;
  temperature?: number;
}

export async function generateWithGemini(options: GenerateOptions): Promise<string> {
  const { systemPrompt, userPrompt, maxTokens = 30000, temperature = 0.7 } = options;

  const modelName = process.env.GEMINI_MODEL || 'gemini-1.5-flash';
  const model = genAI.getGenerativeModel({ 
    model: modelName,
    generationConfig: {
      maxOutputTokens: maxTokens,
      temperature,
    },
  });

  // Gemini ä½¿ç”¨ system instruction
  const chat = model.startChat({
    history: [],
    generationConfig: {
      maxOutputTokens: maxTokens,
      temperature,
    },
  });

  // å°† system prompt å’Œ user prompt åˆå¹¶å‘é€
  const fullPrompt = `${systemPrompt}\n\n---\n\n${userPrompt}`;
  
  const result = await chat.sendMessage(fullPrompt);
  const response = result.response;
  const text = response.text();

  return text;
}

export function parseJsonFromResponse(content: string): any {
  let jsonContent = content.trim();

  // å°è¯•æå– ```json ... ``` ä¸­çš„å†…å®¹
  const jsonMatch = content.match(/```(?:json)?\s*([\s\S]*?)```/);
  if (jsonMatch) {
    jsonContent = jsonMatch[1].trim();
  } else {
    // å°è¯•æ‰¾åˆ° JSON å¯¹è±¡
    const jsonStartIndex = content.indexOf('{');
    const jsonEndIndex = content.lastIndexOf('}');
    if (jsonStartIndex !== -1 && jsonEndIndex !== -1) {
      jsonContent = content.substring(jsonStartIndex, jsonEndIndex + 1);
    }
  }

  return JSON.parse(jsonContent);
}
```

### 4. Kçº¿ä¸»åˆ†æè·¯ç”±

#### `src/routes/generate.ts`

```typescript
import { Router, Request, Response } from 'express';
import { generateWithGemini, parseJsonFromResponse } from '../services/gemini.js';
import { BAZI_SYSTEM_INSTRUCTION, buildMainUserPrompt } from '../prompts/main.js';

const router = Router();

interface BaziInfo {
  name?: string;
  gender: 'Male' | 'Female';
  birthYear: string;
  yearPillar: string;
  monthPillar: string;
  dayPillar: string;
  hourPillar: string;
  startAge: string;
  firstDaYun: string;
}

router.post('/', async (req: Request, res: Response) => {
  try {
    const { baziInfo } = req.body as { baziInfo: BaziInfo };

    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!baziInfo || !baziInfo.yearPillar || !baziInfo.monthPillar || 
        !baziInfo.dayPillar || !baziInfo.hourPillar) {
      return res.status(400).json({ error: 'å…«å­—ä¿¡æ¯ä¸å®Œæ•´' });
    }

    console.log(`[Generate] å¼€å§‹ç”Ÿæˆ Kçº¿åˆ†æ: ${baziInfo.yearPillar} ${baziInfo.monthPillar} ${baziInfo.dayPillar} ${baziInfo.hourPillar}`);

    const userPrompt = buildMainUserPrompt(baziInfo);
    
    const responseText = await generateWithGemini({
      systemPrompt: BAZI_SYSTEM_INSTRUCTION,
      userPrompt,
      maxTokens: 30000,
      temperature: 0.7,
    });

    const data = parseJsonFromResponse(responseText);

    // éªŒè¯è¿”å›æ•°æ®
    if (!data.chartPoints || !Array.isArray(data.chartPoints)) {
      throw new Error('è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼šç¼ºå°‘ chartPoints');
    }

    console.log(`[Generate] ç”ŸæˆæˆåŠŸï¼Œå…± ${data.chartPoints.length} æ¡æ•°æ®`);

    res.json({ success: true, data });

  } catch (error: any) {
    console.error('[Generate] é”™è¯¯:', error);
    res.status(500).json({ 
      error: error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
      code: 'GENERATE_ERROR'
    });
  }
});

export default router;
```

### 5. è´¢å¯Œåˆ†æè·¯ç”±

#### `src/routes/wealth.ts`

```typescript
import { Router, Request, Response } from 'express';
import { generateWithGemini, parseJsonFromResponse } from '../services/gemini.js';
import { WEALTH_ANALYSIS_SYSTEM_INSTRUCTION, buildWealthUserPrompt } from '../prompts/wealth.js';

const router = Router();

interface WealthRequest {
  bazi: string[];
  birthYear: number;
  summary?: string;
  geJu?: string;
  yongShen?: string;
}

router.post('/', async (req: Request, res: Response) => {
  try {
    const { bazi, birthYear, summary, geJu, yongShen } = req.body as WealthRequest;

    if (!bazi || bazi.length !== 4 || !birthYear) {
      return res.status(400).json({ error: 'å…«å­—ä¿¡æ¯ä¸å®Œæ•´' });
    }

    console.log(`[Wealth] å¼€å§‹ç”Ÿæˆè´¢å¯Œåˆ†æ: ${bazi.join(' ')}`);

    const userPrompt = buildWealthUserPrompt({ bazi, birthYear, summary, geJu, yongShen });

    const responseText = await generateWithGemini({
      systemPrompt: WEALTH_ANALYSIS_SYSTEM_INSTRUCTION,
      userPrompt,
      maxTokens: 20000,
      temperature: 0.7,
    });

    const data = parseJsonFromResponse(responseText);

    // æå– wealthAnalysis å¯¹è±¡
    const wealthAnalysis = data.wealthAnalysis || data;

    if (!wealthAnalysis.wealthYearlyData || !Array.isArray(wealthAnalysis.wealthYearlyData)) {
      throw new Error('è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼šç¼ºå°‘ wealthYearlyData');
    }

    console.log(`[Wealth] ç”ŸæˆæˆåŠŸï¼Œå…± ${wealthAnalysis.wealthYearlyData.length} æ¡å¹´åº¦æ•°æ®`);

    res.json({ success: true, data: wealthAnalysis });

  } catch (error: any) {
    console.error('[Wealth] é”™è¯¯:', error);
    res.status(500).json({ 
      error: error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
      code: 'WEALTH_ERROR'
    });
  }
});

export default router;
```

### 6. æ¡ƒèŠ±åˆ†æè·¯ç”±

#### `src/routes/love.ts`

```typescript
import { Router, Request, Response } from 'express';
import { generateWithGemini, parseJsonFromResponse } from '../services/gemini.js';
import { LOVE_ANALYSIS_SYSTEM_INSTRUCTION, buildLoveUserPrompt } from '../prompts/love.js';

const router = Router();

interface LoveRequest {
  bazi: string[];
  birthYear: number;
  summary?: string;
  geJu?: string;
  yongShen?: string;
}

router.post('/', async (req: Request, res: Response) => {
  try {
    const { bazi, birthYear, summary, geJu, yongShen } = req.body as LoveRequest;

    if (!bazi || bazi.length !== 4 || !birthYear) {
      return res.status(400).json({ error: 'å…«å­—ä¿¡æ¯ä¸å®Œæ•´' });
    }

    console.log(`[Love] å¼€å§‹ç”Ÿæˆæ¡ƒèŠ±åˆ†æ: ${bazi.join(' ')}`);

    const userPrompt = buildLoveUserPrompt({ bazi, birthYear, summary, geJu, yongShen });

    const responseText = await generateWithGemini({
      systemPrompt: LOVE_ANALYSIS_SYSTEM_INSTRUCTION,
      userPrompt,
      maxTokens: 20000,
      temperature: 0.7,
    });

    const data = parseJsonFromResponse(responseText);

    // æå– loveAnalysis å¯¹è±¡
    const loveAnalysis = data.loveAnalysis || data;

    if (!loveAnalysis.loveYearlyData || !Array.isArray(loveAnalysis.loveYearlyData)) {
      throw new Error('è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼šç¼ºå°‘ loveYearlyData');
    }

    console.log(`[Love] ç”ŸæˆæˆåŠŸï¼Œå…± ${loveAnalysis.loveYearlyData.length} æ¡å¹´åº¦æ•°æ®`);

    res.json({ success: true, data: loveAnalysis });

  } catch (error: any) {
    console.error('[Love] é”™è¯¯:', error);
    res.status(500).json({ 
      error: error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
      code: 'LOVE_ERROR'
    });
  }
});

export default router;
```

### 7. Prompt æ–‡ä»¶

#### `src/prompts/main.ts`

```typescript
// ä»å‰ç«¯ constants.ts å¤åˆ¶ BAZI_SYSTEM_INSTRUCTION
export const BAZI_SYSTEM_INSTRUCTION = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å…«å­—å‘½ç†åˆ†æå¸ˆï¼Œç²¾é€šå­å¹³å…«å­—å‘½ç†å­¦...
ï¼ˆå®Œæ•´å†…å®¹ä»å‰ç«¯ constants.ts å¤åˆ¶ï¼‰
`;

interface BaziInfo {
  name?: string;
  gender: 'Male' | 'Female';
  birthYear: string;
  yearPillar: string;
  monthPillar: string;
  dayPillar: string;
  hourPillar: string;
  startAge: string;
  firstDaYun: string;
}

export function buildMainUserPrompt(baziInfo: BaziInfo): string {
  const genderStr = baziInfo.gender === 'Male' ? 'ç”· (ä¹¾é€ )' : 'å¥³ (å¤é€ )';
  const startAgeInt = parseInt(baziInfo.startAge) || 1;

  // è®¡ç®—å¤§è¿æ–¹å‘
  const firstChar = baziInfo.yearPillar.trim().charAt(0);
  const yangStems = ['ç”²', 'ä¸™', 'æˆŠ', 'åºš', 'å£¬'];
  const isYangYear = yangStems.includes(firstChar);
  const isForward = baziInfo.gender === 'Male' ? isYangYear : !isYangYear;
  const daYunDirectionStr = isForward ? 'é¡ºè¡Œ (Forward)' : 'é€†è¡Œ (Backward)';
  const yearStemPolarity = isYangYear ? 'é˜³' : 'é˜´';

  const directionExample = isForward
    ? "ä¾‹å¦‚ï¼šç¬¬ä¸€æ­¥æ˜¯ã€æˆŠç”³ã€‘ï¼Œç¬¬äºŒæ­¥åˆ™æ˜¯ã€å·±é…‰ã€‘ï¼ˆé¡ºæ’ï¼‰"
    : "ä¾‹å¦‚ï¼šç¬¬ä¸€æ­¥æ˜¯ã€æˆŠç”³ã€‘ï¼Œç¬¬äºŒæ­¥åˆ™æ˜¯ã€ä¸æœªã€‘ï¼ˆé€†æ’ï¼‰";

  return `è¯·æ ¹æ®ä»¥ä¸‹**å·²ç»æ’å¥½çš„**å…«å­—å››æŸ±å’Œ**æŒ‡å®šçš„å¤§è¿ä¿¡æ¯**è¿›è¡Œåˆ†æã€‚

ã€åŸºæœ¬ä¿¡æ¯ã€‘
æ€§åˆ«ï¼š${genderStr}
å§“åï¼š${baziInfo.name || "æœªæä¾›"}
å‡ºç”Ÿå¹´ä»½ï¼š${baziInfo.birthYear}å¹´ (é˜³å†)

ã€å…«å­—å››æŸ±ã€‘
å¹´æŸ±ï¼š${baziInfo.yearPillar} (å¤©å¹²å±æ€§ï¼š${yearStemPolarity})
æœˆæŸ±ï¼š${baziInfo.monthPillar}
æ—¥æŸ±ï¼š${baziInfo.dayPillar}
æ—¶æŸ±ï¼š${baziInfo.hourPillar}

ã€å¤§è¿æ ¸å¿ƒå‚æ•°ã€‘
1. èµ·è¿å¹´é¾„ï¼š${baziInfo.startAge} å² (è™šå²)ã€‚
2. ç¬¬ä¸€æ­¥å¤§è¿ï¼š${baziInfo.firstDaYun}ã€‚
3. **æ’åºæ–¹å‘**ï¼š${daYunDirectionStr}ã€‚

ã€å¿…é¡»æ‰§è¡Œçš„ç®—æ³• - å¤§è¿åºåˆ—ç”Ÿæˆã€‘
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ç”Ÿæˆæ•°æ®ï¼š

1. **é”å®šç¬¬ä¸€æ­¥**ï¼šç¡®è®¤ã€${baziInfo.firstDaYun}ã€‘ä¸ºç¬¬ä¸€æ­¥å¤§è¿ã€‚
2. **è®¡ç®—åºåˆ—**ï¼šæ ¹æ®å…­åç”²å­é¡ºåºå’Œæ–¹å‘ï¼ˆ${daYunDirectionStr}ï¼‰ï¼Œæ¨ç®—å‡ºæ¥ä¸‹æ¥çš„ 9 æ­¥å¤§è¿ã€‚
   ${directionExample}
3. **å¡«å…… JSON**ï¼š
   - Age 1 åˆ° ${startAgeInt - 1}: daYun = "ç«¥é™"
   - Age ${startAgeInt} åˆ° ${startAgeInt + 9}: daYun = [ç¬¬1æ­¥å¤§è¿: ${baziInfo.firstDaYun}]
   - Age ${startAgeInt + 10} åˆ° ${startAgeInt + 19}: daYun = [ç¬¬2æ­¥å¤§è¿]
   - ...ä»¥æ­¤ç±»æ¨ç›´åˆ° 100 å²ã€‚

ã€ç‰¹åˆ«è­¦å‘Šã€‘
- **daYun å­—æ®µ**ï¼šå¿…é¡»å¡«å¤§è¿å¹²æ”¯ï¼ˆ10å¹´ä¸€å˜ï¼‰ï¼Œ**ç»å¯¹ä¸è¦**å¡«æµå¹´å¹²æ”¯ã€‚
- **ganZhi å­—æ®µ**ï¼šå¡«å…¥è¯¥å¹´ä»½çš„**æµå¹´å¹²æ”¯**ï¼ˆæ¯å¹´ä¸€å˜ï¼Œä¾‹å¦‚ 2024=ç”²è¾°ï¼Œ2025=ä¹™å·³ï¼‰ã€‚

ä»»åŠ¡ï¼š
1. ç¡®è®¤æ ¼å±€ä¸å–œå¿Œã€‚
2. ç”Ÿæˆ **1-100 å² (è™šå²)** çš„äººç”Ÿæµå¹´Kçº¿æ•°æ®ã€‚
3. åœ¨ \`reason\` å­—æ®µä¸­æä¾›æµå¹´è¯¦æ‰¹ã€‚
4. ç”Ÿæˆå¸¦è¯„åˆ†çš„å‘½ç†åˆ†ææŠ¥å‘Šã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ç³»ç»ŸæŒ‡ä»¤ç”Ÿæˆ JSON æ•°æ®ã€‚åŠ¡å¿…åªè¿”å›çº¯JSONæ ¼å¼æ•°æ®ï¼Œä¸è¦åŒ…å«ä»»ä½•markdownä»£ç å—æ ‡è®°æˆ–å…¶ä»–æ–‡å­—è¯´æ˜ã€‚`;
}
```

#### `src/prompts/wealth.ts`

```typescript
// ä»å‰ç«¯ constants.ts å¤åˆ¶ WEALTH_ANALYSIS_SYSTEM_INSTRUCTION
export const WEALTH_ANALYSIS_SYSTEM_INSTRUCTION = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å…«å­—å‘½ç†åˆ†æå¸ˆï¼Œä¸“ç²¾è´¢è¿åˆ†æ...
ï¼ˆå®Œæ•´å†…å®¹ä»å‰ç«¯ constants.ts å¤åˆ¶ï¼‰
`;

interface WealthPromptInput {
  bazi: string[];
  birthYear: number;
  summary?: string;
  geJu?: string;
  yongShen?: string;
}

export function buildWealthUserPrompt(input: WealthPromptInput): string {
  return `è¯·æ ¹æ®ä»¥ä¸‹å…«å­—ä¿¡æ¯ç”Ÿæˆè´¢å¯Œæ·±åº¦åˆ†ææŠ¥å‘Šã€‚

ã€å…«å­—å››æŸ±ã€‘
${input.bazi.join('ã€')}
å¹´æŸ±ï¼š${input.bazi[0]}
æœˆæŸ±ï¼š${input.bazi[1]}
æ—¥æŸ±ï¼š${input.bazi[2]}
æ—¶æŸ±ï¼š${input.bazi[3]}

ã€å‡ºç”Ÿå¹´ä»½ã€‘
${input.birthYear}å¹´ (é˜³å†)

ã€å·²æœ‰åˆ†ææ‘˜è¦ã€‘
å‘½ç†æ€»è¯„ï¼š${input.summary || 'å¾…åˆ†æ'}
æ ¼å±€åˆ†æï¼š${input.geJu || 'å¾…åˆ†æ'}
ç”¨ç¥å¿Œç¥ï¼š${input.yongShen || 'å¾…åˆ†æ'}

è¯·ä¸¥æ ¼æŒ‰ç…§ç³»ç»ŸæŒ‡ä»¤ç”Ÿæˆ JSON æ•°æ®ã€‚åŠ¡å¿…åªè¿”å›çº¯JSONæ ¼å¼æ•°æ®ï¼Œä¸è¦åŒ…å«ä»»ä½•markdownä»£ç å—æ ‡è®°æˆ–å…¶ä»–æ–‡å­—è¯´æ˜ã€‚
å¿…é¡»ç”Ÿæˆ wealthYearlyData æ•°ç»„ï¼ŒåŒ…å« 100 æ¡æ•°æ®ï¼ˆ1-100å²ï¼‰ã€‚`;
}
```

#### `src/prompts/love.ts`

```typescript
// ä»å‰ç«¯ constants.ts å¤åˆ¶ LOVE_ANALYSIS_SYSTEM_INSTRUCTION
export const LOVE_ANALYSIS_SYSTEM_INSTRUCTION = `
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å…«å­—å‘½ç†åˆ†æå¸ˆï¼Œä¸“ç²¾å©šå§»æ„Ÿæƒ…åˆ†æ...
ï¼ˆå®Œæ•´å†…å®¹ä»å‰ç«¯ constants.ts å¤åˆ¶ï¼‰
`;

interface LovePromptInput {
  bazi: string[];
  birthYear: number;
  summary?: string;
  geJu?: string;
  yongShen?: string;
}

export function buildLoveUserPrompt(input: LovePromptInput): string {
  return `è¯·æ ¹æ®ä»¥ä¸‹å…«å­—ä¿¡æ¯ç”Ÿæˆæ¡ƒèŠ±è¿åŠ¿æ·±åº¦åˆ†ææŠ¥å‘Šã€‚

ã€å…«å­—å››æŸ±ã€‘
${input.bazi.join('ã€')}
å¹´æŸ±ï¼š${input.bazi[0]}
æœˆæŸ±ï¼š${input.bazi[1]}
æ—¥æŸ±ï¼š${input.bazi[2]}
æ—¶æŸ±ï¼š${input.bazi[3]}

ã€å‡ºç”Ÿå¹´ä»½ã€‘
${input.birthYear}å¹´ (é˜³å†)

ã€å·²æœ‰åˆ†ææ‘˜è¦ã€‘
å‘½ç†æ€»è¯„ï¼š${input.summary || 'å¾…åˆ†æ'}
æ ¼å±€åˆ†æï¼š${input.geJu || 'å¾…åˆ†æ'}
ç”¨ç¥å¿Œç¥ï¼š${input.yongShen || 'å¾…åˆ†æ'}

è¯·ä¸¥æ ¼æŒ‰ç…§ç³»ç»ŸæŒ‡ä»¤ç”Ÿæˆ JSON æ•°æ®ã€‚åŠ¡å¿…åªè¿”å›çº¯JSONæ ¼å¼æ•°æ®ï¼Œä¸è¦åŒ…å«ä»»ä½•markdownä»£ç å—æ ‡è®°æˆ–å…¶ä»–æ–‡å­—è¯´æ˜ã€‚
å¿…é¡»ç”Ÿæˆ loveYearlyData æ•°ç»„ï¼ŒåŒ…å« 100 æ¡æ•°æ®ï¼ˆ1-100å²ï¼‰ã€‚`;
}
```

---

## ğŸŒ å‰ç«¯å®ç°

### 1. API æœåŠ¡å°è£…

#### `services/apiService.ts`ï¼ˆæ–°å»ºï¼‰

```typescript
// services/apiService.ts

// åç«¯æœåŠ¡åœ°å€ï¼ˆå¼€å‘ç¯å¢ƒ / ç”Ÿäº§ç¯å¢ƒï¼‰
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001';

export interface BaziInfo {
  name?: string;
  gender: 'Male' | 'Female';
  birthYear: string;
  yearPillar: string;
  monthPillar: string;
  dayPillar: string;
  hourPillar: string;
  startAge: string;
  firstDaYun: string;
}

export interface GenerateResult {
  success: boolean;
  data?: any;
  error?: string;
}

/**
 * ç”Ÿæˆ Kçº¿ä¸»åˆ†æ
 */
export async function generateMainAnalysis(baziInfo: BaziInfo): Promise<GenerateResult> {
  try {
    const response = await fetch(`${API_BASE_URL}/api/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ baziInfo }),
    });

    const result = await response.json();

    if (!response.ok) {
      return { success: false, error: result.error || 'ç”Ÿæˆå¤±è´¥' };
    }

    return { success: true, data: result.data };
  } catch (error: any) {
    console.error('generateMainAnalysis error:', error);
    return { success: false, error: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' };
  }
}

/**
 * ç”Ÿæˆè´¢å¯Œæ·±åº¦åˆ†æ
 */
export async function generateWealthAnalysis(params: {
  bazi: string[];
  birthYear: number;
  summary?: string;
  geJu?: string;
  yongShen?: string;
}): Promise<GenerateResult> {
  try {
    const response = await fetch(`${API_BASE_URL}/api/wealth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params),
    });

    const result = await response.json();

    if (!response.ok) {
      return { success: false, error: result.error || 'ç”Ÿæˆå¤±è´¥' };
    }

    return { success: true, data: result.data };
  } catch (error: any) {
    console.error('generateWealthAnalysis error:', error);
    return { success: false, error: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' };
  }
}

/**
 * ç”Ÿæˆæ¡ƒèŠ±æ·±åº¦åˆ†æ
 */
export async function generateLoveAnalysis(params: {
  bazi: string[];
  birthYear: number;
  summary?: string;
  geJu?: string;
  yongShen?: string;
}): Promise<GenerateResult> {
  try {
    const response = await fetch(`${API_BASE_URL}/api/love`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params),
    });

    const result = await response.json();

    if (!response.ok) {
      return { success: false, error: result.error || 'ç”Ÿæˆå¤±è´¥' };
    }

    return { success: true, data: result.data };
  } catch (error: any) {
    console.error('generateLoveAnalysis error:', error);
    return { success: false, error: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' };
  }
}
```

### 2. ç¯å¢ƒå˜é‡é…ç½®

#### `.env.development`

```env
VITE_API_BASE_URL=http://localhost:3001
```

#### `.env.production`

```env
VITE_API_BASE_URL=https://api.your-domain.com
```

### 3. ç”Ÿæˆä¸­å¼¹çª—ç»„ä»¶

#### `components/GeneratingModal.tsx`ï¼ˆæ–°å»ºï¼‰

```typescript
import React from 'react';
import { Loader2 } from 'lucide-react';

interface GeneratingModalProps {
  isOpen: boolean;
  title?: string;
  message?: string;
}

const GeneratingModal: React.FC<GeneratingModalProps> = ({
  isOpen,
  title = 'æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š',
  message = 'è¯·ç¨å€™ï¼ŒAI æ­£åœ¨ä¸ºæ‚¨åˆ†æå‘½ç›˜...'
}) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <div className="flex flex-col items-center gap-6">
          {/* åŠ è½½åŠ¨ç”» */}
          <div className="relative">
            <div className="w-20 h-20 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 animate-pulse" />
            <Loader2 className="w-10 h-10 text-white absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 animate-spin" />
          </div>
          
          <div className="text-center">
            <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
            <p className="text-gray-500">{message}</p>
          </div>

          {/* è¿›åº¦æç¤º */}
          <div className="w-full bg-gray-100 rounded-full h-2">
            <div className="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full animate-pulse" 
                 style={{ width: '60%' }} />
          </div>
          
          <p className="text-sm text-gray-400">é¢„è®¡éœ€è¦ 30-60 ç§’</p>
        </div>
      </div>
    </div>
  );
};

export default GeneratingModal;
```

### 4. ä¿®æ”¹ ImportDataMode.tsx

åœ¨ç°æœ‰ç»„ä»¶åŸºç¡€ä¸Šï¼Œå¢åŠ "ä¸€é”®ç”Ÿæˆ"æŒ‰é’®ï¼š

```typescript
// åœ¨ ImportDataMode.tsx ä¸­æ·»åŠ 

import { generateMainAnalysis } from '../services/apiService';
import GeneratingModal from './GeneratingModal';

// åœ¨ç»„ä»¶å†…æ·»åŠ çŠ¶æ€
const [isGenerating, setIsGenerating] = useState(false);
const [generateError, setGenerateError] = useState<string | null>(null);

// æ·»åŠ ä¸€é”®ç”Ÿæˆå‡½æ•°
const handleAutoGenerate = async () => {
  if (!isStep1Valid) return;
  
  setIsGenerating(true);
  setGenerateError(null);
  
  try {
    const result = await generateMainAnalysis({
      name: baziInfo.name,
      gender: baziInfo.gender as 'Male' | 'Female',
      birthYear: baziInfo.birthYear,
      yearPillar: baziInfo.yearPillar,
      monthPillar: baziInfo.monthPillar,
      dayPillar: baziInfo.dayPillar,
      hourPillar: baziInfo.hourPillar,
      startAge: baziInfo.startAge,
      firstDaYun: baziInfo.firstDaYun,
    });
    
    if (result.success && result.data) {
      // è½¬æ¢æ•°æ®æ ¼å¼
      const importedResult = {
        chartData: result.data.chartPoints,
        analysis: {
          bazi: result.data.bazi || [],
          summary: result.data.summary || "æ— æ‘˜è¦",
          // ... å…¶ä»–å­—æ®µ
        },
      };
      onDataImport(importedResult);
    } else {
      setGenerateError(result.error || 'ç”Ÿæˆå¤±è´¥');
    }
  } catch (error: any) {
    setGenerateError(error.message || 'æœªçŸ¥é”™è¯¯');
  } finally {
    setIsGenerating(false);
  }
};

// åœ¨ JSX ä¸­æ·»åŠ æŒ‰é’®ï¼ˆæ­¥éª¤1å®Œæˆåæ˜¾ç¤ºï¼‰
{isStep1Valid && (
  <button
    onClick={handleAutoGenerate}
    disabled={isGenerating}
    className="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 mb-4"
  >
    <Sparkles className="w-5 h-5" />
    âœ¨ ä¸€é”®ç”Ÿæˆå‘½ç†åˆ†æ
  </button>
)}

{generateError && (
  <div className="text-red-500 bg-red-50 p-3 rounded-lg mb-4">
    {generateError}
  </div>
)}

{/* ç”Ÿæˆä¸­å¼¹çª— */}
<GeneratingModal isOpen={isGenerating} />
```

### 5. ä¿®æ”¹ DeepAnalysisPanel.tsx

ç±»ä¼¼åœ°ï¼Œä¸ºè´¢å¯Œå’Œæ¡ƒèŠ±åˆ†ææ·»åŠ ä¸€é”®ç”Ÿæˆï¼š

```typescript
// åœ¨ DeepAnalysisPanel.tsx ä¸­æ·»åŠ 

import { generateWealthAnalysis, generateLoveAnalysis } from '../services/apiService';
import GeneratingModal from './GeneratingModal';

// æ·»åŠ çŠ¶æ€
const [isGeneratingWealth, setIsGeneratingWealth] = useState(false);
const [isGeneratingLove, setIsGeneratingLove] = useState(false);

// è´¢å¯Œä¸€é”®ç”Ÿæˆ
const handleAutoGenerateWealth = async () => {
  setIsGeneratingWealth(true);
  setWealthError(null);
  
  try {
    const result = await generateWealthAnalysis({
      bazi: analysis.bazi,
      birthYear,
      summary: analysis.summary,
      geJu: analysis.geJu,
      yongShen: analysis.yongShen,
    });
    
    if (result.success && result.data) {
      onWealthAnalysisUpdate(result.data);
      setWealthStep('result');
    } else {
      setWealthError(result.error || 'ç”Ÿæˆå¤±è´¥');
    }
  } catch (error: any) {
    setWealthError(error.message);
  } finally {
    setIsGeneratingWealth(false);
  }
};

// æ¡ƒèŠ±ä¸€é”®ç”Ÿæˆ
const handleAutoGenerateLove = async () => {
  setIsGeneratingLove(true);
  setLoveError(null);
  
  try {
    const result = await generateLoveAnalysis({
      bazi: analysis.bazi,
      birthYear,
      summary: analysis.summary,
      geJu: analysis.geJu,
      yongShen: analysis.yongShen,
    });
    
    if (result.success && result.data) {
      onLoveAnalysisUpdate(result.data);
      setLoveStep('result');
    } else {
      setLoveError(result.error || 'ç”Ÿæˆå¤±è´¥');
    }
  } catch (error: any) {
    setLoveError(error.message);
  } finally {
    setIsGeneratingLove(false);
  }
};
```

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### æœåŠ¡å™¨è¦æ±‚

- å¯è®¿é—® Google APIï¼ˆæµ·å¤– VPS æˆ–é…ç½®ä»£ç†ï¼‰
- Node.js 18+
- å»ºè®®é…ç½®ï¼š1 æ ¸ CPU / 1GB RAM èµ·æ­¥

### æ¨è VPS æœåŠ¡å•†

| æœåŠ¡å•† | æœ€ä½ä»·æ ¼ | ä½ç½® | æ¨èåº¦ |
|--------|----------|------|--------|
| Vultr | $5/æœˆ | æ—¥æœ¬/æ–°åŠ å¡ | â­â­â­â­â­ |
| DigitalOcean | $6/æœˆ | æ–°åŠ å¡ | â­â­â­â­ |
| Linode | $5/æœˆ | æ—¥æœ¬ | â­â­â­â­ |
| AWS Lightsail | $3.5/æœˆ | ä¸œäº¬ | â­â­â­â­ |

### éƒ¨ç½²æ­¥éª¤

```bash
# 1. å…‹éš†åç«¯ä»£ç åˆ°æœåŠ¡å™¨
git clone your-repo lifekline-server
cd lifekline-server

# 2. å®‰è£…ä¾èµ–
npm install

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
nano .env  # ç¼–è¾‘å¡«å…¥ GEMINI_API_KEY ç­‰

# 4. æ„å»º
npm run build

# 5. ä½¿ç”¨ PM2 è¿è¡Œ
npm install -g pm2
pm2 start dist/index.js --name lifekline-api

# 6. è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### Nginx åå‘ä»£ç†é…ç½®

```nginx
server {
    listen 443 ssl;
    server_name api.your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
        
        # å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆGemini ç”Ÿæˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰
        proxy_read_timeout 120s;
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
    }
}
```

---

## ğŸ“Š API æ¥å£æ–‡æ¡£

### 1. Kçº¿ä¸»åˆ†æ

**POST** `/api/generate`

**è¯·æ±‚ä½“ï¼š**
```json
{
  "baziInfo": {
    "name": "å¼ ä¸‰",
    "gender": "Male",
    "birthYear": "1990",
    "yearPillar": "åºšåˆ",
    "monthPillar": "ä¸äº¥",
    "dayPillar": "ç”²å­",
    "hourPillar": "å£¬ç”³",
    "startAge": "8",
    "firstDaYun": "ä¸™æˆŒ"
  }
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "success": true,
  "data": {
    "bazi": ["åºšåˆ", "ä¸äº¥", "ç”²å­", "å£¬ç”³"],
    "summary": "...",
    "chartPoints": [
      {"age": 1, "year": 1990, ...},
      ...
    ]
  }
}
```

### 2. è´¢å¯Œæ·±åº¦åˆ†æ

**POST** `/api/wealth`

**è¯·æ±‚ä½“ï¼š**
```json
{
  "bazi": ["åºšåˆ", "ä¸äº¥", "ç”²å­", "å£¬ç”³"],
  "birthYear": 1990,
  "summary": "å‘½ç†æ€»è¯„...",
  "geJu": "æ ¼å±€åˆ†æ...",
  "yongShen": "ç”¨ç¥å¿Œç¥..."
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "success": true,
  "data": {
    "wealthStar": "...",
    "wealthStarScore": 7,
    "wealthYearlyData": [...]
  }
}
```

### 3. æ¡ƒèŠ±æ·±åº¦åˆ†æ

**POST** `/api/love`

**è¯·æ±‚ä½“ï¼š**
```json
{
  "bazi": ["åºšåˆ", "ä¸äº¥", "ç”²å­", "å£¬ç”³"],
  "birthYear": 1990,
  "summary": "å‘½ç†æ€»è¯„...",
  "geJu": "æ ¼å±€åˆ†æ...",
  "yongShen": "ç”¨ç¥å¿Œç¥..."
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "success": true,
  "data": {
    "loveStar": "...",
    "loveStarScore": 8,
    "loveYearlyData": [...]
  }
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### Gemini API é…é¢

| æ¨¡å‹ | å…è´¹é¢åº¦ | ä»˜è´¹ä»·æ ¼ |
|------|----------|----------|
| Gemini 1.5 Flash | 15 RPM / 100ä¸‡ tokens/å¤© | $0.075/M è¾“å…¥, $0.30/M è¾“å‡º |
| Gemini 1.5 Pro | 2 RPM / 5ä¸‡ tokens/å¤© | $1.25/M è¾“å…¥, $5.00/M è¾“å‡º |

> RPM = Requests Per Minuteï¼ˆæ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼‰

### é”™è¯¯å¤„ç†

| é”™è¯¯ç  | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|--------|------|---------|
| 429 | è¶…å‡º API é…é¢ | å‡çº§ä»˜è´¹è®¡åˆ’æˆ–ç­‰å¾…é‡ç½® |
| 503 | Gemini æœåŠ¡ä¸å¯ç”¨ | ç¨åé‡è¯• |
| ENOTFOUND | æ— æ³•è¿æ¥ Google API | æ£€æŸ¥æœåŠ¡å™¨ç½‘ç»œ/ä»£ç†é…ç½® |

---

## ğŸ“ å®æ–½æ¸…å•

### åç«¯å¼€å‘ï¼ˆ1-2 å¤©ï¼‰

- [ ] åˆå§‹åŒ–åç«¯é¡¹ç›® `lifekline-server`
- [ ] é…ç½® Express + TypeScript
- [ ] å®ç° Gemini API å°è£… `services/gemini.ts`
- [ ] å®ç° Kçº¿ä¸»åˆ†æè·¯ç”± `routes/generate.ts`
- [ ] å®ç°è´¢å¯Œåˆ†æè·¯ç”± `routes/wealth.ts`
- [ ] å®ç°æ¡ƒèŠ±åˆ†æè·¯ç”± `routes/love.ts`
- [ ] ä»å‰ç«¯å¤åˆ¶ Prompt å¸¸é‡
- [ ] æœ¬åœ°æµ‹è¯• API

### å‰ç«¯å¼€å‘ï¼ˆ0.5-1 å¤©ï¼‰

- [ ] åˆ›å»º `services/apiService.ts`
- [ ] åˆ›å»º `GeneratingModal.tsx` ç»„ä»¶
- [ ] ä¿®æ”¹ `ImportDataMode.tsx` - æ·»åŠ ä¸€é”®ç”Ÿæˆ
- [ ] ä¿®æ”¹ `DeepAnalysisPanel.tsx` - æ·»åŠ ä¸€é”®ç”Ÿæˆ
- [ ] é…ç½®ç¯å¢ƒå˜é‡ `.env.development` / `.env.production`

### éƒ¨ç½²ï¼ˆ0.5 å¤©ï¼‰

- [ ] è´­ä¹°/é…ç½®æµ·å¤– VPS
- [ ] éƒ¨ç½²åç«¯æœåŠ¡
- [ ] é…ç½® Nginx åå‘ä»£ç†
- [ ] é…ç½® SSL è¯ä¹¦
- [ ] æ›´æ–°å‰ç«¯ç”Ÿäº§ç¯å¢ƒé…ç½®
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

---

## ğŸ“ ä¸‹ä¸€æ­¥

æ–‡æ¡£å·²æ›´æ–°å®Œæˆï¼Œç¡®è®¤åæˆ‘å¯ä»¥å¼€å§‹å®ç°ä»£ç ï¼š

1. **å…ˆåˆ›å»ºåç«¯é¡¹ç›®** - `lifekline-server` å®Œæ•´ä»£ç 
2. **å†ä¿®æ”¹å‰ç«¯ä»£ç ** - æ·»åŠ  API è°ƒç”¨å’Œç”ŸæˆæŒ‰é’®

æ˜¯å¦å¼€å§‹å®ç°ï¼Ÿ
