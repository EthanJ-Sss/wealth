# äººç”ŸKçº¿ - è‡ªåŠ¨å‘è´§æœºå™¨äººè®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

### 1.1 éœ€æ±‚èƒŒæ™¯

å–å®¶åœ¨å¤šä¸ªç”µå•†å¹³å°ï¼ˆæ·˜å®ã€å’¸é±¼ã€å°çº¢ä¹¦ç­‰ï¼‰é”€å”®"äººç”ŸKçº¿"æœåŠ¡ï¼Œç”¨æˆ·ä»˜æ¬¾åéœ€è¦è‡ªåŠ¨å‘é€è´¦å·å¯†ç ã€‚æœ¬æœºå™¨äººè´Ÿè´£ï¼š

1. ç›‘å¬å„å¹³å°è®¢å•
2. è‡ªåŠ¨ä»è´¦å·æ± åˆ†é…è´¦å·
3. å‘ä¹°å®¶å‘é€è´¦å·ä¿¡æ¯
4. è®°å½•å‘è´§æ—¥å¿—

### 1.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| è·¨å¹³å° | ç»Ÿä¸€æ¶æ„æ”¯æŒå¤šç”µå•†å¹³å° |
| è‡ªåŠ¨åŒ– | 24å°æ—¶æ— äººå€¼å®ˆè¿è¡Œ |
| å¯é æ€§ | å‘è´§å¤±è´¥è‡ªåŠ¨é‡è¯•ã€å‘Šè­¦ |
| å¯è¿½æº¯ | å®Œæ•´çš„å‘è´§æ—¥å¿— |
| æ˜“æ‰©å±• | æ–°å¢å¹³å°åªéœ€å®ç°é€‚é…å™¨ |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          è‡ªåŠ¨å‘è´§ç³»ç»Ÿ                                    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         æ ¸å¿ƒæœåŠ¡å±‚                                  â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  è´¦å·æ± ç®¡ç†  â”‚  â”‚  è®¢å•é˜Ÿåˆ—   â”‚  â”‚  å‘è´§å¼•æ“   â”‚  â”‚  é€šçŸ¥æœåŠ¡  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚AccountPool â”‚  â”‚ OrderQueue â”‚  â”‚DeliveryEngineâ”‚  â”‚ Notifier  â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚         â”‚                â”‚                â”‚               â”‚        â”‚ â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         å¹³å°é€‚é…å±‚                                 â”‚  â”‚
â”‚  â”‚                                  â”‚                                 â”‚  â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚    â”‚                             â”‚                             â”‚  â”‚  â”‚
â”‚  â”‚    â–¼                             â–¼                             â–¼  â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚ â”‚ TaobaoAdapterâ”‚  â”‚  XianyuAdapter       â”‚  â”‚XiaohongshuAdapterâ”‚  â”‚  â”‚
â”‚  â”‚ â”‚   æ·˜å®é€‚é…å™¨  â”‚  â”‚   å’¸é±¼é€‚é…å™¨         â”‚  â”‚  å°çº¢ä¹¦é€‚é…å™¨    â”‚  â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                     â”‚                       â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                       â”‚
            â–¼                     â–¼                       â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   æ·˜å®å¹³å°    â”‚  â”‚    å’¸é±¼å¹³å°       â”‚  â”‚   å°çº¢ä¹¦å¹³å°     â”‚
     â”‚   åƒç‰›/API   â”‚  â”‚  é—²é±¼å¼€æ”¾å¹³å°     â”‚  â”‚   ä¸“ä¸šå·åå°     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| è¿è¡Œæ—¶ | Node.js / Python | å¼‚æ­¥IOï¼Œé€‚åˆçˆ¬è™«/è‡ªåŠ¨åŒ– |
| æ¶ˆæ¯é˜Ÿåˆ— | Redis / RabbitMQ | è®¢å•é˜Ÿåˆ—ã€é‡è¯•é˜Ÿåˆ— |
| æ•°æ®åº“ | MySQL / SQLite | å­˜å‚¨è´¦å·æ± ã€å‘è´§è®°å½• |
| æµè§ˆå™¨è‡ªåŠ¨åŒ– | Puppeteer / Playwright | æ¨¡æ‹Ÿç™»å½•ã€æ¶ˆæ¯å‘é€ |
| å®šæ—¶ä»»åŠ¡ | node-cron / APScheduler | å®šæœŸæ£€æŸ¥è®¢å• |
| å‘Šè­¦ | é’‰é’‰/é£ä¹¦/Telegram Bot | å¼‚å¸¸é€šçŸ¥ç®¡ç†å‘˜ |

---

## 3. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.1 ç»Ÿä¸€é€‚é…å™¨æ¥å£

```typescript
/**
 * ç”µå•†å¹³å°é€‚é…å™¨æ¥å£
 * æ‰€æœ‰å¹³å°å¿…é¡»å®ç°æ­¤æ¥å£
 */
interface IPlatformAdapter {
  /** å¹³å°åç§° */
  readonly name: string;
  
  /** å¹³å°æ ‡è¯† */
  readonly platformId: 'taobao' | 'xianyu' | 'xiaohongshu' | 'pdd';
  
  /**
   * åˆå§‹åŒ–é€‚é…å™¨ï¼ˆç™»å½•ç­‰ï¼‰
   */
  initialize(): Promise<void>;
  
  /**
   * è·å–å¾…å‘è´§è®¢å•åˆ—è¡¨
   */
  fetchPendingOrders(): Promise<Order[]>;
  
  /**
   * å‘é€æ¶ˆæ¯ç»™ä¹°å®¶
   * @param order è®¢å•ä¿¡æ¯
   * @param message æ¶ˆæ¯å†…å®¹
   * @returns æ˜¯å¦å‘é€æˆåŠŸ
   */
  sendMessage(order: Order, message: string): Promise<DeliveryResult>;
  
  /**
   * æ ‡è®°è®¢å•ä¸ºå·²å‘è´§
   */
  markAsDelivered(orderId: string): Promise<boolean>;
  
  /**
   * æ£€æŸ¥é€‚é…å™¨å¥åº·çŠ¶æ€
   */
  healthCheck(): Promise<boolean>;
  
  /**
   * æ¸…ç†èµ„æº
   */
  cleanup(): Promise<void>;
}

/**
 * è®¢å•æ•°æ®ç»“æ„
 */
interface Order {
  orderId: string;          // å¹³å°è®¢å•å·
  platform: string;         // å¹³å°æ ‡è¯†
  buyerId: string;          // ä¹°å®¶ID
  buyerNickname: string;    // ä¹°å®¶æ˜µç§°
  productId: string;        // å•†å“ID
  productName: string;      // å•†å“åç§°
  quantity: number;         // æ•°é‡
  amount: number;           // é‡‘é¢
  paidAt: Date;             // ä»˜æ¬¾æ—¶é—´
  status: OrderStatus;      // è®¢å•çŠ¶æ€
  extra?: Record<string, any>;
}

/**
 * å‘è´§ç»“æœ
 */
interface DeliveryResult {
  success: boolean;
  messageId?: string;       // æ¶ˆæ¯ID
  error?: string;           // é”™è¯¯ä¿¡æ¯
  retryable?: boolean;      // æ˜¯å¦å¯é‡è¯•
}
```

### 3.2 è´¦å·æ± ç®¡ç†å™¨

```typescript
class AccountPoolManager {
  /**
   * è·å–ä¸€ä¸ªå¯ç”¨è´¦å·
   * @param orderId å…³è”è®¢å•å·
   * @param platform æ¥æºå¹³å°
   */
  async allocate(orderId: string, platform: string): Promise<Account | null> {
    // 1. æŸ¥è¯¢ status='unused' çš„è´¦å·
    // 2. ä½¿ç”¨äº‹åŠ¡é”å®š
    // 3. æ›´æ–° status='active', order_id, platform
    // 4. è¿”å›è´¦å·ä¿¡æ¯
  }
  
  /**
   * å›æ”¶è´¦å·ï¼ˆè®¢å•å–æ¶ˆ/é€€æ¬¾æ—¶ï¼‰
   */
  async recycle(orderId: string): Promise<boolean> {
    // 1. æŸ¥è¯¢è¯¥è®¢å•å…³è”çš„è´¦å·
    // 2. å¦‚æœ first_login_at ä¸ºç©ºï¼ˆæœªä½¿ç”¨ï¼‰ï¼Œé‡ç½®ä¸º unused
    // 3. æ¸…é™¤ order_id, platform
  }
  
  /**
   * è·å–è´¦å·æ± çŠ¶æ€
   */
  async getPoolStatus(): Promise<PoolStatus> {
    return {
      total: await this.countAll(),
      unused: await this.countByStatus('unused'),
      active: await this.countByStatus('active'),
      expired: await this.countByStatus('expired'),
    };
  }
  
  /**
   * æ‰¹é‡ç”Ÿæˆè´¦å·
   */
  async generateBatch(count: number, usesPerAccount: number): Promise<Account[]> {
    const accounts: Account[] = [];
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    
    for (let i = 0; i < count; i++) {
      const seq = String(await this.getNextSequence()).padStart(5, '0');
      const username = `LK${date}${seq}`;
      const password = this.generatePassword();
      
      accounts.push({
        id: uuid(),
        username,
        password,
        passwordHash: await bcrypt.hash(password, 10),
        remainingUses: usesPerAccount,
        status: 'unused',
      });
    }
    
    await this.batchInsert(accounts);
    return accounts;
  }
  
  private generatePassword(): string {
    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
    const length = 8 + Math.floor(Math.random() * 4); // 8-11ä½
    let password = '';
    for (let i = 0; i < length; i++) {
      password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
  }
}
```

### 3.3 å‘è´§å¼•æ“

```typescript
class DeliveryEngine {
  private adapters: Map<string, IPlatformAdapter> = new Map();
  private accountPool: AccountPoolManager;
  private notifier: Notifier;
  
  /**
   * æ³¨å†Œå¹³å°é€‚é…å™¨
   */
  registerAdapter(adapter: IPlatformAdapter): void {
    this.adapters.set(adapter.platformId, adapter);
  }
  
  /**
   * å¤„ç†å•ä¸ªè®¢å•
   */
  async processOrder(order: Order): Promise<void> {
    const adapter = this.adapters.get(order.platform);
    if (!adapter) {
      throw new Error(`æœªæ‰¾åˆ°å¹³å°é€‚é…å™¨: ${order.platform}`);
    }
    
    // 1. åˆ†é…è´¦å·
    const account = await this.accountPool.allocate(order.orderId, order.platform);
    if (!account) {
      await this.notifier.alert('è´¦å·æ± å·²è€—å°½ï¼è¯·åŠæ—¶è¡¥å……');
      throw new Error('è´¦å·æ± å·²è€—å°½');
    }
    
    // 2. ç”Ÿæˆå‘è´§æ¶ˆæ¯
    const message = this.buildDeliveryMessage(account, order);
    
    // 3. å‘é€æ¶ˆæ¯
    const result = await this.sendWithRetry(adapter, order, message);
    
    // 4. è®°å½•æ—¥å¿—
    await this.logDelivery(order, account, result);
    
    // 5. æ ‡è®°å·²å‘è´§
    if (result.success) {
      await adapter.markAsDelivered(order.orderId);
    }
  }
  
  /**
   * å¸¦é‡è¯•çš„å‘é€
   */
  private async sendWithRetry(
    adapter: IPlatformAdapter,
    order: Order,
    message: string,
    maxRetries: number = 3
  ): Promise<DeliveryResult> {
    let lastError: string | undefined;
    
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const result = await adapter.sendMessage(order, message);
        if (result.success) return result;
        
        lastError = result.error;
        if (!result.retryable) break;
        
        // æŒ‡æ•°é€€é¿
        await this.delay(Math.pow(2, attempt) * 1000);
      } catch (error: any) {
        lastError = error.message;
      }
    }
    
    return { success: false, error: lastError, retryable: false };
  }
  
  /**
   * æ„å»ºå‘è´§æ¶ˆæ¯
   */
  private buildDeliveryMessage(account: Account, order: Order): string {
    return `
ã€äººç”ŸKçº¿ - è´¦å·å‘è´§æˆåŠŸã€‘

æ‚¨çš„ä¸“å±è´¦å·å·²ç”Ÿæˆ âœ¨

ğŸ” ç™»å½•ä¿¡æ¯ï¼š
è´¦å·ï¼š${account.username}
å¯†ç ï¼š${account.password}

ğŸ“Š ä½¿ç”¨æ¬¡æ•°ï¼š${account.remainingUses}æ¬¡

ğŸŒ ä½¿ç”¨åœ°å€ï¼šhttps://lifekline.com

ğŸ“ ä½¿ç”¨è¯´æ˜ï¼š
1. è®¿é—®ä¸Šæ–¹ç½‘å€
2. ç‚¹å‡»"ç™»å½•"è¾“å…¥è´¦å·å¯†ç 
3. å¼€å§‹ç”Ÿæˆæ‚¨çš„äººç”ŸKçº¿å›¾

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
- è´¦å·ä»…é™æœ¬äººä½¿ç”¨
- ç”Ÿæˆæ¬¡æ•°ç”¨å®Œåå¯ç»­è´­
- å¦‚æœ‰é—®é¢˜è¯·è”ç³»å®¢æœ

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼
    `.trim();
  }
}
```

---

## 4. å¹³å°é€‚é…å™¨å®ç°

### 4.1 æ·˜å®/å¤©çŒ«é€‚é…å™¨

#### æ–¹æ¡ˆé€‰æ‹©

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|-------|
| **æ·˜å®å¼€æ”¾å¹³å° API** | å®˜æ–¹æ”¯æŒï¼Œç¨³å®š | éœ€ä¼ä¸šèµ„è´¨å®¡æ ¸ | â­â­â­â­â­ |
| **åƒç‰›æ¶ˆæ¯æ¥å£** | å•†å®¶å¿…å¤‡å·¥å…· | éœ€è¦ä»˜è´¹ç‰ˆæœ¬ | â­â­â­â­ |
| **æµè§ˆå™¨è‡ªåŠ¨åŒ–** | æ— éœ€å®¡æ ¸ | ä¸ç¨³å®šï¼Œæ˜“è¢«é£æ§ | â­â­ |

#### æ·˜å®å¼€æ”¾å¹³å°å®ç°

```typescript
class TaobaoAdapter implements IPlatformAdapter {
  name = 'æ·˜å®/å¤©çŒ«';
  platformId = 'taobao' as const;
  
  private client: TaobaoClient;
  private accessToken: string;
  
  async initialize(): Promise<void> {
    // OAuth2 æˆæƒè·å– access_token
    this.client = new TaobaoClient({
      appKey: process.env.TAOBAO_APP_KEY,
      appSecret: process.env.TAOBAO_APP_SECRET,
    });
    this.accessToken = await this.refreshToken();
  }
  
  async fetchPendingOrders(): Promise<Order[]> {
    // è°ƒç”¨ taobao.trades.sold.get æ¥å£
    const response = await this.client.execute('taobao.trades.sold.get', {
      fields: 'tid,buyer_nick,payment,status,pay_time',
      status: 'WAIT_SELLER_SEND_GOODS', // å¾…å‘è´§
    }, this.accessToken);
    
    return response.trades.map(this.mapToOrder);
  }
  
  async sendMessage(order: Order, message: string): Promise<DeliveryResult> {
    try {
      // è°ƒç”¨ taobao.wangwang.eservice.chatlog.write å‘é€æ¶ˆæ¯
      // æˆ–ä½¿ç”¨äº¤æ˜“å¤‡æ³¨ taobao.trade.memo.add
      await this.client.execute('taobao.trade.memo.add', {
        tid: order.orderId,
        memo: message,
        flag: 1, // çº¢æ——æ ‡è®°
      }, this.accessToken);
      
      return { success: true };
    } catch (error: any) {
      return { success: false, error: error.message, retryable: true };
    }
  }
  
  async markAsDelivered(orderId: string): Promise<boolean> {
    // è™šæ‹Ÿå•†å“è‡ªåŠ¨å‘è´§
    await this.client.execute('taobao.logistics.dummy.send', {
      tid: orderId,
      feature: 'nocheck=true',
    }, this.accessToken);
    return true;
  }
}
```

### 4.2 å’¸é±¼é€‚é…å™¨

#### æ–¹æ¡ˆè¯´æ˜

å’¸é±¼æš‚æ— å®˜æ–¹å¼€æ”¾å¹³å°ï¼Œä¸»è¦é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

| æ–¹æ¡ˆ | å®ç°éš¾åº¦ | ç¨³å®šæ€§ |
|------|---------|-------|
| **é—²é±¼è‡ªåŠ¨å›å¤æœºå™¨äºº** | ä½ | ä¸­ |
| **æµè§ˆå™¨è‡ªåŠ¨åŒ–ï¼ˆPlaywrightï¼‰** | ä¸­ | ä½ |
| **APP æŠ“åŒ… + æ¨¡æ‹Ÿè¯·æ±‚** | é«˜ | ä¸æ¨è |

#### æµè§ˆå™¨è‡ªåŠ¨åŒ–å®ç°

```typescript
class XianyuAdapter implements IPlatformAdapter {
  name = 'å’¸é±¼';
  platformId = 'xianyu' as const;
  
  private browser: Browser;
  private page: Page;
  
  async initialize(): Promise<void> {
    this.browser = await chromium.launch({ headless: false });
    this.page = await this.browser.newPage();
    
    // åŠ è½½å·²ä¿å­˜çš„ç™»å½•çŠ¶æ€
    const cookies = await this.loadCookies();
    if (cookies) {
      await this.page.context().addCookies(cookies);
    }
    
    // è®¿é—®å’¸é±¼
    await this.page.goto('https://www.goofish.com/');
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå¿…è¦æ—¶æ‰‹åŠ¨ç™»å½•
    if (!(await this.isLoggedIn())) {
      console.log('è¯·åœ¨æµè§ˆå™¨ä¸­æ‰‹åŠ¨ç™»å½•å’¸é±¼...');
      await this.waitForLogin();
      await this.saveCookies();
    }
  }
  
  async fetchPendingOrders(): Promise<Order[]> {
    // å¯¼èˆªåˆ°"æˆ‘å–å‡ºçš„"é¡µé¢
    await this.page.goto('https://www.goofish.com/personal?tabKey=sold');
    
    // ç­‰å¾…è®¢å•åˆ—è¡¨åŠ è½½
    await this.page.waitForSelector('.order-list');
    
    // æå–å¾…å‘è´§è®¢å•
    const orders = await this.page.evaluate(() => {
      const items = document.querySelectorAll('.order-item[data-status="å¾…å‘è´§"]');
      return Array.from(items).map(item => ({
        orderId: item.getAttribute('data-order-id'),
        buyerNickname: item.querySelector('.buyer-name')?.textContent,
        // ... å…¶ä»–å­—æ®µ
      }));
    });
    
    return orders.map(this.mapToOrder);
  }
  
  async sendMessage(order: Order, message: string): Promise<DeliveryResult> {
    try {
      // è¿›å…¥èŠå¤©é¡µé¢
      await this.page.goto(`https://www.goofish.com/im?targetId=${order.buyerId}`);
      
      // ç­‰å¾…è¾“å…¥æ¡†
      await this.page.waitForSelector('.chat-input');
      
      // è¾“å…¥æ¶ˆæ¯
      await this.page.fill('.chat-input', message);
      
      // å‘é€
      await this.page.click('.send-button');
      
      // ç­‰å¾…å‘é€æˆåŠŸ
      await this.page.waitForSelector('.message-sent-success');
      
      return { success: true };
    } catch (error: any) {
      return { success: false, error: error.message, retryable: true };
    }
  }
}
```

### 4.3 å°çº¢ä¹¦é€‚é…å™¨

#### æ–¹æ¡ˆè¯´æ˜

å°çº¢ä¹¦å•†å®¶åå°æä¾›äº†ä¸€å®šçš„ API èƒ½åŠ›ï¼š

| æ–¹æ¡ˆ | è¯´æ˜ |
|------|------|
| **å°çº¢ä¹¦å¼€æ”¾å¹³å°** | éœ€è¦æˆä¸ºå…¥é©»å•†å®¶ |
| **ä¸“ä¸šå·åå°è‡ªåŠ¨åŒ–** | ä½¿ç”¨ Playwright |

#### å®ç°ç¤ºä¾‹

```typescript
class XiaohongshuAdapter implements IPlatformAdapter {
  name = 'å°çº¢ä¹¦';
  platformId = 'xiaohongshu' as const;
  
  private browser: Browser;
  private page: Page;
  
  async initialize(): Promise<void> {
    this.browser = await chromium.launch({ headless: false });
    this.page = await this.browser.newPage();
    
    // åŠ è½½å•†å®¶åå°
    await this.page.goto('https://ark.xiaohongshu.com/');
    
    // ç™»å½•æµç¨‹ï¼ˆæ”¯æŒæ‰«ç ï¼‰
    if (!(await this.isLoggedIn())) {
      console.log('è¯·æ‰«ç ç™»å½•å°çº¢ä¹¦å•†å®¶åå°...');
      await this.waitForLogin();
    }
  }
  
  async fetchPendingOrders(): Promise<Order[]> {
    // è¿›å…¥è®¢å•ç®¡ç†é¡µé¢
    await this.page.goto('https://ark.xiaohongshu.com/order/list?status=å¾…å‘è´§');
    
    // æå–è®¢å•åˆ—è¡¨
    // ...
  }
  
  async sendMessage(order: Order, message: string): Promise<DeliveryResult> {
    // é€šè¿‡ç§ä¿¡å‘é€
    // æˆ–é€šè¿‡è®¢å•å¤‡æ³¨
    // ...
  }
}
```

---

## 5. å·¥ä½œæµç¨‹

### 5.1 ä¸»å¾ªç¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä¸»å¾ªç¯                                 â”‚
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚   â”‚  å¯åŠ¨ç³»ç»Ÿ  â”‚                                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚              åˆå§‹åŒ–æ‰€æœ‰å¹³å°é€‚é…å™¨                       â”‚ â”‚
â”‚   â”‚  - æ·˜å®: OAuthæˆæƒ                                     â”‚ â”‚
â”‚   â”‚  - å’¸é±¼: åŠ è½½Cookies/æ‰«ç ç™»å½•                          â”‚ â”‚
â”‚   â”‚  - å°çº¢ä¹¦: åŠ è½½Cookies/æ‰«ç ç™»å½•                        â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  æ¯60ç§’å¾ªç¯  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  å®šæ—¶ä»»åŠ¡  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  å¹¶è¡Œæ‹‰å–å„å¹³å°å¾…å‘è´§è®¢å•  â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                 è®¢å•å»é‡ & å…¥é˜Ÿåˆ—                       â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚              ä»é˜Ÿåˆ—å–å‡ºè®¢å•ï¼Œé€ä¸ªå¤„ç†                   â”‚ â”‚
â”‚   â”‚                                                         â”‚ â”‚
â”‚   â”‚   For each order:                                       â”‚ â”‚
â”‚   â”‚     1. åˆ†é…è´¦å·                                         â”‚ â”‚
â”‚   â”‚     2. å‘é€æ¶ˆæ¯                                         â”‚ â”‚
â”‚   â”‚     3. æ ‡è®°å‘è´§                                         â”‚ â”‚
â”‚   â”‚     4. è®°å½•æ—¥å¿—                                         â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                   å¼‚å¸¸å¤„ç† & å‘Šè­¦                       â”‚ â”‚
â”‚   â”‚                                                         â”‚ â”‚
â”‚   â”‚   - å‘é€å¤±è´¥ â†’ é‡è¯•é˜Ÿåˆ—ï¼ˆæœ€å¤š3æ¬¡ï¼‰                      â”‚ â”‚
â”‚   â”‚   - è´¦å·æ± ä¸è¶³ â†’ é’‰é’‰/é£ä¹¦å‘Šè­¦                          â”‚ â”‚
â”‚   â”‚   - é€‚é…å™¨å¼‚å¸¸ â†’ è®°å½•å¹¶è·³è¿‡                             â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å‘è´§æµç¨‹è¯¦è§£

```typescript
async function deliveryWorkflow(order: Order): Promise<void> {
  const startTime = Date.now();
  let deliveryLog: DeliveryLog = {
    orderId: order.orderId,
    platform: order.platform,
    buyerId: order.buyerId,
    startTime: new Date(),
    status: 'processing',
  };
  
  try {
    // Step 1: æ£€æŸ¥æ˜¯å¦å·²å‘è´§ï¼ˆé˜²é‡å¤ï¼‰
    if (await isAlreadyDelivered(order.orderId)) {
      console.log(`è®¢å• ${order.orderId} å·²å‘è´§ï¼Œè·³è¿‡`);
      return;
    }
    
    // Step 2: åˆ†é…è´¦å·
    const account = await accountPool.allocate(order.orderId, order.platform);
    if (!account) {
      deliveryLog.status = 'failed';
      deliveryLog.error = 'è´¦å·æ± å·²è€—å°½';
      await notifier.alert('âš ï¸ è´¦å·æ± å·²è€—å°½ï¼Œè¯·ç«‹å³è¡¥å……ï¼');
      throw new Error('è´¦å·æ± å·²è€—å°½');
    }
    deliveryLog.accountId = account.id;
    deliveryLog.accountUsername = account.username;
    
    // Step 3: ç”Ÿæˆå‘è´§æ¶ˆæ¯
    const message = buildDeliveryMessage(account, order);
    
    // Step 4: å‘é€æ¶ˆæ¯ï¼ˆå¸¦é‡è¯•ï¼‰
    const adapter = getAdapter(order.platform);
    const result = await sendWithRetry(adapter, order, message);
    
    if (!result.success) {
      deliveryLog.status = 'failed';
      deliveryLog.error = result.error;
      
      // å‘é€å¤±è´¥ï¼Œå›æ”¶è´¦å·
      await accountPool.recycle(order.orderId);
      
      // åŠ å…¥é‡è¯•é˜Ÿåˆ—
      if (result.retryable) {
        await retryQueue.push(order);
      }
      
      throw new Error(`å‘é€å¤±è´¥: ${result.error}`);
    }
    
    // Step 5: æ ‡è®°è®¢å•å·²å‘è´§
    await adapter.markAsDelivered(order.orderId);
    
    // Step 6: è®°å½•æˆåŠŸ
    deliveryLog.status = 'success';
    deliveryLog.messageId = result.messageId;
    deliveryLog.duration = Date.now() - startTime;
    
    console.log(`âœ… è®¢å• ${order.orderId} å‘è´§æˆåŠŸ`);
    
  } catch (error: any) {
    deliveryLog.error = error.message;
    throw error;
  } finally {
    deliveryLog.endTime = new Date();
    await saveDeliveryLog(deliveryLog);
  }
}
```

---

## 6. æ•°æ®å­˜å‚¨

### 6.1 å‘è´§è®°å½•è¡¨

```sql
CREATE TABLE delivery_logs (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    
    -- è®¢å•ä¿¡æ¯
    order_id        VARCHAR(64) NOT NULL,
    platform        VARCHAR(32) NOT NULL,
    buyer_id        VARCHAR(64),
    buyer_nickname  VARCHAR(64),
    product_name    VARCHAR(256),
    amount          DECIMAL(10, 2),
    
    -- è´¦å·ä¿¡æ¯
    account_id      VARCHAR(36),
    account_username VARCHAR(32),
    
    -- å‘è´§çŠ¶æ€
    status          ENUM('processing', 'success', 'failed', 'retrying') NOT NULL,
    error_message   TEXT,
    retry_count     INT DEFAULT 0,
    message_id      VARCHAR(64),           -- å¹³å°è¿”å›çš„æ¶ˆæ¯ID
    
    -- æ—¶é—´
    order_paid_at   TIMESTAMP,             -- è®¢å•ä»˜æ¬¾æ—¶é—´
    started_at      TIMESTAMP,             -- å¼€å§‹å¤„ç†æ—¶é—´
    completed_at    TIMESTAMP,             -- å®Œæˆæ—¶é—´
    duration_ms     INT,                   -- å¤„ç†è€—æ—¶
    
    -- ç´¢å¼•
    INDEX idx_order (order_id),
    INDEX idx_platform (platform),
    INDEX idx_status (status),
    INDEX idx_account (account_id),
    INDEX idx_completed (completed_at)
);
```

### 6.2 é‡è¯•é˜Ÿåˆ—

ä½¿ç”¨ Redis å®ç°ï¼š

```typescript
// é‡è¯•é˜Ÿåˆ— Key
const RETRY_QUEUE_KEY = 'delivery:retry:queue';
const RETRY_DELAY_KEY = 'delivery:retry:delay';

// åŠ å…¥é‡è¯•é˜Ÿåˆ—
async function pushToRetryQueue(order: Order): Promise<void> {
  const retryCount = await getRetryCount(order.orderId);
  if (retryCount >= 3) {
    console.log(`è®¢å• ${order.orderId} é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œæ”¾å¼ƒ`);
    return;
  }
  
  // æŒ‡æ•°é€€é¿å»¶è¿Ÿ
  const delay = Math.pow(2, retryCount + 1) * 60 * 1000; // 2åˆ†é’Ÿ, 4åˆ†é’Ÿ, 8åˆ†é’Ÿ
  const executeAt = Date.now() + delay;
  
  await redis.zadd(RETRY_QUEUE_KEY, executeAt, JSON.stringify(order));
  await redis.incr(`${RETRY_DELAY_KEY}:${order.orderId}`);
}

// å¤„ç†é‡è¯•é˜Ÿåˆ—
async function processRetryQueue(): Promise<void> {
  const now = Date.now();
  const items = await redis.zrangebyscore(RETRY_QUEUE_KEY, 0, now);
  
  for (const item of items) {
    const order = JSON.parse(item);
    await deliveryWorkflow(order);
    await redis.zrem(RETRY_QUEUE_KEY, item);
  }
}
```

---

## 7. ç›‘æ§ä¸å‘Šè­¦

### 7.1 ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|------|------|---------|
| `delivery_success_rate` | å‘è´§æˆåŠŸç‡ | < 95% |
| `account_pool_remaining` | å‰©ä½™è´¦å·æ•° | < 50 |
| `avg_delivery_time` | å¹³å‡å‘è´§è€—æ—¶ | > 5åˆ†é’Ÿ |
| `retry_queue_size` | é‡è¯•é˜Ÿåˆ—å¤§å° | > 100 |
| `adapter_health` | é€‚é…å™¨å¥åº·çŠ¶æ€ | ä»»ä¸€ç¦»çº¿ |

### 7.2 å‘Šè­¦é€šçŸ¥

```typescript
class Notifier {
  private dingTalkWebhook: string;
  private feishuWebhook: string;
  private telegramBotToken: string;
  private telegramChatId: string;
  
  async alert(message: string, level: 'info' | 'warning' | 'error' = 'warning'): Promise<void> {
    const formattedMessage = `
[${level.toUpperCase()}] äººç”ŸKçº¿å‘è´§æœºå™¨äºº

${message}

æ—¶é—´: ${new Date().toLocaleString('zh-CN')}
    `.trim();
    
    // å¹¶è¡Œå‘é€åˆ°æ‰€æœ‰æ¸ é“
    await Promise.allSettled([
      this.sendDingTalk(formattedMessage),
      this.sendFeishu(formattedMessage),
      this.sendTelegram(formattedMessage),
    ]);
  }
  
  private async sendDingTalk(message: string): Promise<void> {
    await fetch(this.dingTalkWebhook, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        msgtype: 'text',
        text: { content: message },
      }),
    });
  }
  
  // ... å…¶ä»–æ¸ é“å®ç°
}
```

### 7.3 æ—¥æŠ¥ç»Ÿè®¡

```typescript
async function generateDailyReport(): Promise<string> {
  const today = new Date().toISOString().slice(0, 10);
  
  const stats = await db.query(`
    SELECT 
      platform,
      COUNT(*) as total,
      SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as success,
      SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
      AVG(duration_ms) as avg_duration
    FROM delivery_logs
    WHERE DATE(completed_at) = ?
    GROUP BY platform
  `, [today]);
  
  const poolStatus = await accountPool.getPoolStatus();
  
  return `
ğŸ“Š äººç”ŸKçº¿å‘è´§æ—¥æŠ¥ (${today})

ã€å‘è´§ç»Ÿè®¡ã€‘
${stats.map(s => `
${s.platform}: 
  - æ€»è®¡: ${s.total} å•
  - æˆåŠŸ: ${s.success} å• (${(s.success/s.total*100).toFixed(1)}%)
  - å¤±è´¥: ${s.failed} å•
  - å¹³å‡è€—æ—¶: ${(s.avg_duration/1000).toFixed(1)}s
`).join('\n')}

ã€è´¦å·æ± çŠ¶æ€ã€‘
- æ€»è´¦å·: ${poolStatus.total}
- æœªä½¿ç”¨: ${poolStatus.unused}
- å·²æ¿€æ´»: ${poolStatus.active}
- å·²è¿‡æœŸ: ${poolStatus.expired}

${poolStatus.unused < 100 ? 'âš ï¸ è´¦å·æ± ä¸è¶³100ï¼Œè¯·åŠæ—¶è¡¥å……ï¼' : 'âœ… è´¦å·æ± å……è¶³'}
  `.trim();
}
```

---

## 8. éƒ¨ç½²æ–¹æ¡ˆ

### 8.1 è¿è¡Œç¯å¢ƒ

```yaml
# docker-compose.yml
version: '3.8'

services:
  delivery-bot:
    build: .
    environment:
      - DATABASE_URL=mysql://user:pass@db:3306/lifekline
      - REDIS_URL=redis://redis:6379
      - TAOBAO_APP_KEY=${TAOBAO_APP_KEY}
      - TAOBAO_APP_SECRET=${TAOBAO_APP_SECRET}
      - DINGTALK_WEBHOOK=${DINGTALK_WEBHOOK}
    volumes:
      - ./data:/app/data  # å­˜å‚¨ cookies ç­‰
    depends_on:
      - db
      - redis
    restart: unless-stopped
    
  db:
    image: mysql:8.0
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=lifekline
      
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  mysql_data:
  redis_data:
```

### 8.2 é…ç½®æ–‡ä»¶

```typescript
// config.ts
export const config = {
  // è½®è¯¢é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  pollInterval: 60 * 1000,
  
  // å‘è´§æ¶ˆæ¯æ¨¡æ¿
  messageTemplate: `
ã€äººç”ŸKçº¿ - è´¦å·å‘è´§æˆåŠŸã€‘

æ‚¨çš„ä¸“å±è´¦å·å·²ç”Ÿæˆ âœ¨

ğŸ” ç™»å½•ä¿¡æ¯ï¼š
è´¦å·ï¼š{{username}}
å¯†ç ï¼š{{password}}

ğŸ“Š ä½¿ç”¨æ¬¡æ•°ï¼š{{uses}}æ¬¡

ğŸŒ ä½¿ç”¨åœ°å€ï¼šhttps://lifekline.com
  `,
  
  // é‡è¯•é…ç½®
  retry: {
    maxAttempts: 3,
    baseDelay: 2 * 60 * 1000, // 2åˆ†é’Ÿ
  },
  
  // å‘Šè­¦é…ç½®
  alert: {
    accountPoolThreshold: 50,
    successRateThreshold: 0.95,
  },
  
  // å¹³å°é…ç½®
  platforms: {
    taobao: {
      enabled: true,
      appKey: process.env.TAOBAO_APP_KEY,
      appSecret: process.env.TAOBAO_APP_SECRET,
    },
    xianyu: {
      enabled: true,
      cookiePath: './data/xianyu-cookies.json',
    },
    xiaohongshu: {
      enabled: false, // æŒ‰éœ€å¼€å¯
      cookiePath: './data/xhs-cookies.json',
    },
  },
};
```

---

## 9. å®æ–½è®¡åˆ’

### Phase 1: æ ¸å¿ƒæ¡†æ¶ï¼ˆ1å‘¨ï¼‰

- [ ] æ­å»ºé¡¹ç›®ç»“æ„
- [ ] å®ç°è´¦å·æ± ç®¡ç†å™¨
- [ ] å®ç°å‘è´§å¼•æ“
- [ ] æ•°æ®åº“è¡¨åˆ›å»º

### Phase 2: æ·˜å®é€‚é…å™¨ï¼ˆ1å‘¨ï¼‰

- [ ] å¯¹æ¥æ·˜å®å¼€æ”¾å¹³å°
- [ ] å®ç°è®¢å•æ‹‰å–
- [ ] å®ç°æ¶ˆæ¯å‘é€
- [ ] æµ‹è¯•å®Œæ•´æµç¨‹

### Phase 3: å’¸é±¼é€‚é…å™¨ï¼ˆ1å‘¨ï¼‰

- [ ] å®ç°æµè§ˆå™¨è‡ªåŠ¨åŒ–
- [ ] Cookie æŒä¹…åŒ–
- [ ] æ¶ˆæ¯å‘é€é€‚é…
- [ ] å¼‚å¸¸å¤„ç†

### Phase 4: ç›‘æ§å‘Šè­¦ï¼ˆ3å¤©ï¼‰

- [ ] å¯¹æ¥é’‰é’‰/é£ä¹¦
- [ ] å®ç°æ—¥æŠ¥åŠŸèƒ½
- [ ] å¼‚å¸¸å‘Šè­¦

### Phase 5: éƒ¨ç½²ä¸Šçº¿ï¼ˆ2å¤©ï¼‰

- [ ] Docker å®¹å™¨åŒ–
- [ ] éƒ¨ç½²åˆ°æœåŠ¡å™¨
- [ ] è¿ç»´æ–‡æ¡£

---

## 10. é™„å½•

### 10.1 å¸¸è§é—®é¢˜

**Q: æµè§ˆå™¨è‡ªåŠ¨åŒ–ä¼šè¢«å¹³å°æ£€æµ‹å—ï¼Ÿ**

A: æœ‰å¯èƒ½ã€‚å»ºè®®ï¼š
1. ä½¿ç”¨çœŸå®æµè§ˆå™¨æŒ‡çº¹
2. æ¨¡æ‹Ÿäººç±»æ“ä½œï¼ˆéšæœºå»¶è¿Ÿï¼‰
3. ä¸è¦é¢‘ç¹æ“ä½œ
4. ä¼˜å…ˆä½¿ç”¨å®˜æ–¹ API

**Q: è´¦å·æ± ä¸è¶³æ€ä¹ˆåŠï¼Ÿ**

A: 
1. è®¾ç½®å‘Šè­¦é˜ˆå€¼ï¼ˆå¦‚ < 100 ä¸ªï¼‰
2. æå‰æ‰¹é‡ç”Ÿæˆè´¦å·
3. æ—¥æŠ¥ä¸­æé†’è¡¥å……

**Q: è®¢å•å–æ¶ˆ/é€€æ¬¾å¦‚ä½•å¤„ç†ï¼Ÿ**

A: 
1. å®šæœŸæ£€æŸ¥å·²å‘è´§è®¢å•çŠ¶æ€
2. å‘ç°é€€æ¬¾ï¼Œè°ƒç”¨ `accountPool.recycle(orderId)`
3. å¦‚æœè´¦å·æœªä½¿ç”¨ï¼Œé‡æ–°å…¥æ± 

### 10.2 API å‚è€ƒ

- [æ·˜å®å¼€æ”¾å¹³å°](https://open.taobao.com/)
- [å°çº¢ä¹¦å¼€æ”¾å¹³å°](https://open.xiaohongshu.com/)
- [Playwright æ–‡æ¡£](https://playwright.dev/)
